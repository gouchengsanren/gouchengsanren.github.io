<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="gcc的一些基础知识。编译到底做了一些什么，编译时的注意事项等等。">
<meta property="og:type" content="article">
<meta property="og:title" content="gcc">
<meta property="og:url" content="http://yoursite.com/2020/04/12/gcc/index.html">
<meta property="og:site_name" content="陋室录">
<meta property="og:description" content="gcc的一些基础知识。编译到底做了一些什么，编译时的注意事项等等。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-04-12T08:14:49.000Z">
<meta property="article:modified_time" content="2020-04-24T23:42:13.239Z">
<meta property="article:author" content="缑城散人">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/04/12/gcc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>gcc | 陋室录</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">陋室录</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">信奉阳明心学</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/12/gcc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="缑城散人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陋室录">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          gcc
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-12 08:14:49" itemprop="dateCreated datePublished" datetime="2020-04-12T08:14:49+00:00">2020-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 23:42:13" itemprop="dateModified" datetime="2020-04-24T23:42:13+00:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/compile/" itemprop="url" rel="index"><span itemprop="name">compile</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>gcc的一些基础知识。<br>编译到底做了一些什么，编译时的注意事项等等。</p>
<a id="more"></a>

<h2 id="头文件的位置"><a href="#头文件的位置" class="headerlink" title="头文件的位置"></a>头文件的位置</h2><p>像 <code>stdio.h</code> 在编译器中的 <code>include</code> 目录。<br>自己需要的头文件，编译时用 <code>-I</code> 指定，比如 <code>-I ./</code><br><br></p>
<h2 id="库的位置"><a href="#库的位置" class="headerlink" title="库的位置"></a>库的位置</h2><p>像 <code>printf</code> 函数，都在事先编好的库中。库在编译器中的 <code>lib</code> 目录。<br>编译时，</p>
<ul>
<li>用 <code>-lxxx</code> 指定需要的库，编译器会去 <code>lib</code> 、 <code>usr/lib</code> 目录下找叫 <code>libxxx.so</code><br><code>libxxx.so.数字</code> <code>libxxx.a</code> 的库文件。</li>
<li>用 <code>-L xxx</code> 指定库的路径。<br>
<br>

</li>
</ul>
<h2 id="GCC的编译过程"><a href="#GCC的编译过程" class="headerlink" title="GCC的编译过程"></a>GCC的编译过程</h2><p>韦老师团队写的下面这篇文档非常好。<br><a href="https://github.com/100askTeam/01_all_series_quickstart/blob/master/04_%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8_%E6%AD%A3%E5%BC%8F%E5%BC%80%E5%A7%8B/01_%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/doc_pic/01.%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.docx" target="_blank" rel="noopener">01.嵌入式Linux应用开发基础知识.docx</a></p>
<p>最初的程序是程序员对着巨大的机器插拔线缆。<br>之后有了纸带打孔编程，指代上的洞代表01，一条纸带就是要给程序。<br>再之后，就用一段特定的代码来表示一段特定的01串。这就是汇编语言。<br>再往后，就出现了c等高级语言。</p>
<p>对老师的文档做下摘要和总结。</p>
<p>一个c/cpp文件的编译分为4步：</p>
<ul>
<li>1）预处理，preprocessing。</li>
<li>2）编译，compilation。</li>
<li>3）汇编，assembly。</li>
<li>4）链接，linking。</li>
</ul>
<br>

<h3 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h3><p>在c/cpp中，以 <code>#</code> 开头的都叫做 <code>预处理命令</code> ，包括 <code>#include</code> <code>#define</code> <code>#if</code> 等。<br>预处理要做的就是将它们展开或选择需要编译的代码。</p>
<p>例：<br><code>gcc -E -o main.i main.c -I ./</code><br>预处理不加 <code>-o</code> 选项时，会以标准输出的形式打出来。<br>预处理，需要 <code>-I</code> 。一但 <code>.i</code> 文件生成了，后续的编译就不需要再指定 <code>-I</code> 了。<br><br></p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>代码决定后，正式将这些c/cpp代码转换成汇编代码。<br>用到的工具为 <code>cc1</code> 。</p>
<p>例：<br><code>gcc -S main.i</code> 或者 <code>gcc -S -o main.s main.i</code><br>指不指定输出都可以。不指定，默认就是*.s。<br><br></p>
<h3 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h3><p>汇编就是将汇编代码转换成机器码。<br>用到的工具为 <code>as</code> 。</p>
<p>例：<br><code>gcc -c main.s</code> 或者 <code>gcc -c -o main.o main.s</code><br>指不指定输出都可以。不指定，默认就是*.o。<br><br></p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>链接就是将多个 <code>.o文件</code> <code>.so文件</code> 链接起来，生成app。<br>用到的工具为 <code>ld</code> 或者 <code>collect2</code> 。</p>
<p>例：<br><code>gcc -o main main.o sub.o</code><br>这里就必须指定了，否则默认生成的是 <code>a.out</code> 。<br><br></p>
<h3 id="gcc-v"><a href="#gcc-v" class="headerlink" title="gcc -v"></a>gcc -v</h3><p>可以通过 <code>-v</code> 看到上述过程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -o main main.c sub.c -I ./ -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ../src/configure -v --with-pkgversion='Ubuntu 7.5.0-3ubuntu1~18.04' --with-bugurl=file:///usr/share/doc/gcc-7/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr --with-gcc-major-version-only --program-suffix=-7 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04) </span><br><span class="line">COLLECT_GCC_OPTIONS='-o' 'main' '-I' './' '-v' '-mtune=generic' '-march=x86-64'</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/cc1 -quiet -v -I ./ -imultiarch x86_64-linux-gnu main.c -quiet -dumpbase main.c -mtune=generic -march=x86-64 -auxbase main -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/ccZkhzNQ.s</span><br><span class="line">GNU C11 (Ubuntu 7.5.0-3ubuntu1~18.04) version 7.5.0 (x86_64-linux-gnu)</span><br><span class="line">    compiled by GNU C version 7.5.0, GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version isl-0.19-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">ignoring nonexistent directory "/usr/local/include/x86_64-linux-gnu"</span><br><span class="line">ignoring nonexistent directory "/usr/lib/gcc/x86_64-linux-gnu/7/../../../../x86_64-linux-gnu/include"</span><br><span class="line"><span class="meta">#</span><span class="bash">include <span class="string">"..."</span> search starts here:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include &lt;...&gt; search starts here:</span></span><br><span class="line"> ./</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br><span class="line">GNU C11 (Ubuntu 7.5.0-3ubuntu1~18.04) version 7.5.0 (x86_64-linux-gnu)</span><br><span class="line">    compiled by GNU C version 7.5.0, GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version isl-0.19-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: b62ed4a2880cd4159476ea8293b72fa8</span><br><span class="line">COLLECT_GCC_OPTIONS='-o' 'main' '-I' './' '-v' '-mtune=generic' '-march=x86-64'</span><br><span class="line"> as -v -I ./ --64 -o /tmp/cc3Tp9Or.o /tmp/ccZkhzNQ.s</span><br><span class="line">GNU assembler version 2.30 (x86_64-linux-gnu) using BFD version (GNU Binutils for Ubuntu) 2.30</span><br><span class="line">COLLECT_GCC_OPTIONS='-o' 'main' '-I' './' '-v' '-mtune=generic' '-march=x86-64'</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/cc1 -quiet -v -I ./ -imultiarch x86_64-linux-gnu sub.c -quiet -dumpbase sub.c -mtune=generic -march=x86-64 -auxbase sub -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/ccZkhzNQ.s</span><br><span class="line">GNU C11 (Ubuntu 7.5.0-3ubuntu1~18.04) version 7.5.0 (x86_64-linux-gnu)</span><br><span class="line">    compiled by GNU C version 7.5.0, GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version isl-0.19-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">ignoring nonexistent directory "/usr/local/include/x86_64-linux-gnu"</span><br><span class="line">ignoring nonexistent directory "/usr/lib/gcc/x86_64-linux-gnu/7/../../../../x86_64-linux-gnu/include"</span><br><span class="line"><span class="meta">#</span><span class="bash">include <span class="string">"..."</span> search starts here:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include &lt;...&gt; search starts here:</span></span><br><span class="line"> ./</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br><span class="line">GNU C11 (Ubuntu 7.5.0-3ubuntu1~18.04) version 7.5.0 (x86_64-linux-gnu)</span><br><span class="line">    compiled by GNU C version 7.5.0, GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version isl-0.19-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: b62ed4a2880cd4159476ea8293b72fa8</span><br><span class="line">sub.c: In function ‘sub_fun’:</span><br><span class="line">sub.c:3:8: warning: implicit declaration of function ‘printf’ [-Wimplicit-function-declaration]</span><br><span class="line">        printf("Sub fun!\n");</span><br><span class="line">        ^~~~~~</span><br><span class="line">sub.c:3:8: warning: incompatible implicit declaration of built-in function ‘printf’</span><br><span class="line">sub.c:3:8: note: include ‘&lt;stdio.h&gt;’ or provide a declaration of ‘printf’</span><br><span class="line">COLLECT_GCC_OPTIONS='-o' 'main' '-I' './' '-v' '-mtune=generic' '-march=x86-64'</span><br><span class="line"> as -v -I ./ --64 -o /tmp/ccA3F0W2.o /tmp/ccZkhzNQ.s</span><br><span class="line">GNU assembler version 2.30 (x86_64-linux-gnu) using BFD version (GNU Binutils for Ubuntu) 2.30</span><br><span class="line">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/</span><br><span class="line">LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/7/../../../:/lib/:/usr/lib/</span><br><span class="line">COLLECT_GCC_OPTIONS='-o' 'main' '-I' './' '-v' '-mtune=generic' '-march=x86-64'</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/7/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper -plugin-opt=-fresolution=/tmp/ccskUa6D.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86-64.so.2 -pie -z now -z relro -o main /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/7/crtbeginS.o -L/usr/lib/gcc/x86_64-linux-gnu/7 -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/7/../../.. /tmp/cc3Tp9Or.o /tmp/ccA3F0W2.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/7/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crtn.o</span><br><span class="line">COLLECT_GCC_OPTIONS='-o' 'main' '-I' './' '-v' '-mtune=generic' '-march=x86-64'</span><br></pre></td></tr></table></figure>

<p>可以清晰的看出编译的过程。<br>其中：<br><code>/usr/lib/gcc/x86_64-linux-gnu/7/cc1</code> 生成的 <code>.s</code> ， <code>as</code> 生成的 <code>.o</code> 都位于 <code>/tmp/</code> 目录下。<br>最终链接使用的是 <code>/usr/lib/gcc/x86_64-linux-gnu/7/collect2</code> 。<br><br></p>
<h3 id="gcc-Wall"><a href="#gcc-Wall" class="headerlink" title="gcc -Wall"></a>gcc -Wall</h3><p>打开告警。<br><br></p>
<h3 id="gcc-g"><a href="#gcc-g" class="headerlink" title="gcc -g"></a>gcc -g</h3><p>以操作系统的本地格式（stabs，COFF，XCOFF，或DWARF）产生调试信息，gdb能使用这些信息。<br>我们反汇编，也必须加上 <code>-g</code> ，否则没有函数信息，看不懂汇编的就会一脸懵逼。</p>
<p>加上 <code>-g</code> 后，文件明显的就变大了。<br>例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -c main.c -I ./</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 28</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 18 08:42 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 08:16 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1608 Apr 18 08:42 main.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -c main.c -I ./ -g -o a.o</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 36</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 18 08:43 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 08:16 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck 5992 Apr 18 08:43 a.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1608 Apr 18 08:42 main.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br></pre></td></tr></table></figure>
<br>


<h3 id="gcc-O"><a href="#gcc-O" class="headerlink" title="gcc -O"></a>gcc -O</h3><p>优化选项。没有搞懂的欲望。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-O</td>
<td>不优化</td>
</tr>
<tr>
<td>-O2</td>
<td><strong>TODO</strong></td>
</tr>
<tr>
<td>-O3</td>
<td><strong>TODO</strong></td>
</tr>
</tbody></table>
<p>例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -c main.c -I ./ -O2 -o main_o2.o</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -c main.c -I ./</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -c main.c -I ./ -O3 -o main_o3.o</span><br><span class="line">chuck@chuck11:~/bsp$ gcc -c main.c -I ./ -O1 -o main_o1.o</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 40</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 18 08:50 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 08:16 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1608 Apr 18 08:50 main.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1624 Apr 18 08:50 main_o1.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1728 Apr 18 08:50 main_o2.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1728 Apr 18 08:50 main_o3.o</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br></pre></td></tr></table></figure>
<p>随着优化等级变高，代码变多了。<br><br></p>
<h3 id="链接选项"><a href="#链接选项" class="headerlink" title="链接选项"></a>链接选项</h3><p>选项比较多，可以参考：<br><a href="https://github.com/100askTeam/01_all_series_quickstart/blob/master/04_%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8_%E6%AD%A3%E5%BC%8F%E5%BC%80%E5%A7%8B/01_%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/doc_pic/01.%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.docx" target="_blank" rel="noopener">01.嵌入式Linux应用开发基础知识.docx</a></p>
<h4 id="动态库和静态库"><a href="#动态库和静态库" class="headerlink" title="动态库和静态库"></a>动态库和静态库</h4><p>我们先来讲讲库。<br>库分：</p>
<ul>
<li>静态库， <code>.a</code> 文件</li>
<li>动态库， <code>.so</code> 文件</li>
</ul>
<p><strong>动态库</strong><br>通过 <code>-shared</code> 选项生成 。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -shared sub.c -o libsub.so</span><br><span class="line">chuck@chuck11:~/bsp$ gcc -o main main.c -I ./ -lsub -L ./</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ./main </span><br><span class="line">./main: error while loading shared libraries: libsub.so: cannot open shared object file: No such file or directory</span><br><span class="line">chuck@chuck11:~/bsp$ ll main</span><br><span class="line">-rwxrwxr-x 1 chuck chuck 8328 Apr 18 17:50 main*</span><br></pre></td></tr></table></figure>
<p>注意我故意列出了main的大小 <code>8328</code> 字节。<br><em><code>-shared</code> 不加 <code>-o</code> 默认生成的文件为 <code>a.out</code> ，所以一定要加 <code>-o</code> ，否则没法链接的。</em></p>
<p><strong>静态库</strong></p>
<blockquote>
<p>那么 <code>.a</code> 和 <code>.so</code> 是否仅仅是名字上的差别呢？</p>
</blockquote>
<p>我们来做个实验。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -shared sub.c -o libsub.a</span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 40</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 18 17:56 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 17:32 ../</span><br><span class="line">-rwxrwxr-x  1 chuck chuck 7896 Apr 18 17:56 libsub.a*</span><br><span class="line">-rwxrwxr-x  1 chuck chuck 7896 Apr 18 17:50 libsub.so*</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -o main main.c -I ./ -lsub -L ./</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ./main </span><br><span class="line">./main: error while loading shared libraries: libsub.so: cannot open shared object file: No such file or directory</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ rm libsub.so </span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -o main main.c -I ./ -lsub -L ./</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ./main </span><br><span class="line">Main fun!</span><br><span class="line">Sub fun!</span><br><span class="line">chuck@chuck11:~/bsp$ ll main</span><br><span class="line">-rwxrwxr-x 1 chuck chuck 8328 Apr 18 17:56 main*</span><br><span class="line">chuck@chuck11:~/bsp$ diff libsub.a libsub.so</span><br><span class="line">chuck@chuck11:~/bsp$</span><br></pre></td></tr></table></figure>
<p>会发现：</p>
<ul>
<li>1）使用 <code>-shared</code> 生成 <code>.a</code> 和 <code>.so</code> 内容是一样的</li>
<li>2）链接，优先使用 <code>.so</code></li>
<li>3）链接后，使用 <code>.a</code> 链接的main是可以直接运行的！！！</li>
<li>4）<code>main</code> 的大小并没有差异，说明仍然是在运行时动态链接的</li>
</ul>
<p>我们继续实验：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ cd ../</span><br><span class="line">chuck@chuck11:~$ </span><br><span class="line">chuck@chuck11:~$ cp bsp/main .</span><br><span class="line">chuck@chuck11:~$ </span><br><span class="line">chuck@chuck11:~$ ./main </span><br><span class="line">./main: error while loading shared libraries: .//libsub.a: cannot open shared object file: No such file or directory</span><br><span class="line">chuck@chuck11:~$ </span><br><span class="line">chuck@chuck11:~$ cp bsp/libsub.a .</span><br><span class="line">chuck@chuck11:~$ ./main </span><br><span class="line">Main fun!</span><br><span class="line">Sub fun!</span><br><span class="line">chuck@chuck11:~$</span><br></pre></td></tr></table></figure>
<p>也就是说，链接 <code>.a</code> 的app运行时要求库在当前目录，而链接 <code>.so</code> 的app运行时要求库在 <code>lib</code> 目录。</p>
<p>我们做下印证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~$ su</span><br><span class="line">Password: </span><br><span class="line">root@chuck11:/home/chuck# </span><br><span class="line">root@chuck11:/home/chuck# cp bsp/libsub.a /usr/lib/</span><br><span class="line">root@chuck11:/home/chuck# ./main </span><br><span class="line">./main: error while loading shared libraries: .//libsub.a: cannot open shared object file: No such file or directory</span><br><span class="line">root@chuck11:/home/chuck# cp bsp/libsub.so /usr/lib/</span><br><span class="line">root@chuck11:/home/chuck# ./main </span><br><span class="line">./main: error while loading shared libraries: .//libsub.a: cannot open shared object file: No such file or directory</span><br><span class="line">root@chuck11:/home/chuck#</span><br><span class="line">root@chuck11:/home/chuck# cd bsp/</span><br><span class="line">root@chuck11:/home/chuck/bsp# gcc -o main main.c -I ./ -L ./ -lsub</span><br><span class="line">root@chuck11:/home/chuck/bsp# </span><br><span class="line">root@chuck11:/home/chuck/bsp# ./main </span><br><span class="line">Main fun!</span><br><span class="line">Sub fun!</span><br></pre></td></tr></table></figure>
<p>和预期一致。</p>
<blockquote>
<p>那么静态库正确的生成方法是？</p>
</blockquote>
<p>参考：<br><a href="http://c.biancheng.net/view/7168.html" target="_blank" rel="noopener">gcc生成静态链接库</a></p>
<p>我们使用 <code>ar</code> 命令。<br><code>ar rcs + 静态库文件的名字 + 目标文件列表</code><br>事实上，ar是linux的一个备份压缩命令，它将多个文件打包成一个备份文件（归档文件），<br>反过来也可以提取。</p>
<p>参数说明：</p>
<ul>
<li><code>r</code> 用来替换库中已有的目标文件，或者加入新的目标文件</li>
<li><code>c</code> 表示创建一个库。不管库否存在，都将创建</li>
<li><code>s</code> 用来创建目标文件索引，这在创建较大的库时能提高速度</li>
</ul>
<p>我们不需要记住每个参数的含义，记住使用 <code>ar rcs</code> 即可。<br>例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -c -o sub.o sub.c</span><br><span class="line">chuck@chuck11:~/bsp$ ar rcs libsub.a sub.o </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -o main main.c -I ./ -L ./ -lsub</span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 44</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 18 18:38 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 18:34 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1680 Apr 18 18:38 libsub.a</span><br><span class="line">-rwxrwxr-x  1 chuck chuck 8360 Apr 18 18:38 main*</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br><span class="line">-rw-rw-r--  1 chuck chuck 1536 Apr 18 18:38 sub.o</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ./main </span><br><span class="line">Main fun!</span><br><span class="line">Sub fun!</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ cd ../</span><br><span class="line">chuck@chuck11:~$ cp bsp/main .</span><br><span class="line">chuck@chuck11:~$ ./main </span><br><span class="line">Main fun!</span><br><span class="line">Sub fun!</span><br><span class="line">chuck@chuck11:~$</span><br></pre></td></tr></table></figure>
<p>不论哪个目录，<code>main</code> 都可以运行。而且大小相较动态库，变大了 <code>8360</code> 。<br>这才是静态库。</p>
<blockquote>
<p><em>注意：<code>ar</code> 打包的是归档文件，即 <code>.o</code> 文件，不能直接 <code>ar .c</code></em></p>
</blockquote>
<p>错误示范：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ ar rcs -o libsub.a sub.c </span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 28</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 18 18:43 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 18:42 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck  120 Apr 18 18:43 libsub.a</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -o main main.c -I ./ -L ./ -lsub</span><br><span class="line">.//libsub.a: error adding symbols: Archive has no index; run ranlib to add one</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br></pre></td></tr></table></figure>
<p>可以发现，libsub.a很小。显然sub.c并没有被编译，记住ar只是一个打包命令，它不编译。</p>
<blockquote>
<p>也就是说，<strong>静态库</strong>只是 <code>.o</code> 的打包文件而已，它不想 <code>.so</code> 那样加了其他内容。</p>
</blockquote>
<br>


<h4 id="static"><a href="#static" class="headerlink" title="-static"></a>-static</h4><blockquote>
<p>那么除了静态库，有什么办法可以把动态库直接编译进app呢？</p>
</blockquote>
<p>有。使用 <code>-static</code> 选项。<br>该选项在编译时会直接把库编译进app。</p>
<p>例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 32</span><br><span class="line">drwxrwxr-x  2 chuck chuck 4096 Apr 19 01:08 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck 4096 Apr 18 18:51 ../</span><br><span class="line">-rwxrwxr-x  1 chuck chuck 7896 Apr 19 01:06 libsub.so*</span><br><span class="line">-rw-rw-r--  1 chuck chuck  153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck  139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck   52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck   19 Apr 12 12:51 sub.h</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -static -o main main.c -I ./ -L ./ -lsub</span><br><span class="line">/usr/bin/ld: cannot find -lsub</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -c sub.c </span><br><span class="line">chuck@chuck11:~/bsp$ ar rcs -o libsub.a sub.o </span><br><span class="line">chuck@chuck11:~/bsp$ gcc -static -o main main.c -I ./ -L ./ -lsub</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 868</span><br><span class="line">drwxrwxr-x  2 chuck chuck   4096 Apr 19 01:12 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck   4096 Apr 18 18:51 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck   1680 Apr 19 01:12 libsub.a</span><br><span class="line">-rwxrwxr-x  1 chuck chuck   7896 Apr 19 01:06 libsub.so*</span><br><span class="line">-rwxrwxr-x  1 chuck chuck 844760 Apr 19 01:13 main*</span><br><span class="line">-rw-rw-r--  1 chuck chuck    153 Apr 12 12:52 main.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck    139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck     52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck     19 Apr 12 12:51 sub.h</span><br><span class="line">-rw-rw-r--  1 chuck chuck   1536 Apr 19 01:10 sub.o</span><br><span class="line">chuck@chuck11:~/bsp$</span><br></pre></td></tr></table></figure>
<p>我做了2个尝试：</p>
<ul>
<li>1）尝试用 <code>-static</code> 编译进自己的 <code>libsub.so</code> 库，但失败了。实践表明不能通过<br>   <code>-static</code> 将自己的动态库编译进app。</li>
<li>2）编出 <code>.a</code> 静态库，使用 <code>-static</code> 成功了。说明自己的静态库可以。</li>
</ul>
<p><em>注意，编出的main有 <code>844k</code></em></p>
<blockquote>
<p>难道 <code>libc</code> 默认库是静态库？不可能啊，如果是静态库，为什么现在main编出来大了整整 <code>100倍</code> ？</p>
</blockquote>
<p>我们可以通过 <code>ldd</code> 确认一个app到底使用了那些库：<br>参考：<br><a href="http://c.biancheng.net/view/7483.html" target="_blank" rel="noopener">ldd</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ gcc -static -o main_static main.c -I ./ -L ./ -lsub</span><br><span class="line">chuck@chuck11:~/bsp$ gcc -o main_dynamic main.c -I ./ -L ./ -lsub</span><br><span class="line">chuck@chuck11:~/bsp$ ll</span><br><span class="line">total 880</span><br><span class="line">drwxrwxr-x  2 chuck chuck   4096 Apr 19 01:16 ./</span><br><span class="line">drwxr-xr-x 17 chuck chuck   4096 Apr 18 18:51 ../</span><br><span class="line">-rw-rw-r--  1 chuck chuck   1680 Apr 19 01:12 libsub.a</span><br><span class="line">-rwxrwxr-x  1 chuck chuck   7896 Apr 19 01:06 libsub.so*</span><br><span class="line">-rw-rw-r--  1 chuck chuck    153 Apr 12 12:52 main.c</span><br><span class="line">-rwxrwxr-x  1 chuck chuck   8328 Apr 19 01:16 main_dynamic*</span><br><span class="line">-rwxrwxr-x  1 chuck chuck 844760 Apr 19 01:16 main_static*</span><br><span class="line">-rw-rw-r--  1 chuck chuck    139 Apr 12 12:51 Makefile</span><br><span class="line">-rw-rw-r--  1 chuck chuck     52 Apr 12 12:51 sub.c</span><br><span class="line">-rw-rw-r--  1 chuck chuck     19 Apr 12 12:51 sub.h</span><br><span class="line">-rw-rw-r--  1 chuck chuck   1536 Apr 19 01:10 sub.o</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ldd main_static </span><br><span class="line">    not a dynamic executable</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ ldd main_dynamic </span><br><span class="line">    linux-vdso.so.1 (0x00007fffbe917000)</span><br><span class="line">    libsub.so =&gt; not found</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fbc7afeb000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007fbc7b5de000)</span><br></pre></td></tr></table></figure>
<p>我编了两个main，一个静态的（ <code>main_static</code> ），一个动态的（ <code>main_dynamic</code> ）。<br>使用 <code>ldd</code> 查看，非 <code>-static</code> 生成的main，使用的c库是 <code>libc.so.6</code> 确实是动态库。</p>
<blockquote>
<p>那自己的so和标准库的so，有什么区别呢？</p>
</blockquote>
<p>我们通过 <code>file</code> 看下文件类型：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">chuck@chuck11:~/bsp$ file libsub.so </span><br><span class="line">libsub.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=e4d3fd11a9247f7c75680cc54340daf8b58f4cc8, not stripped</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ file libsub.a </span><br><span class="line">libsub.a: current ar archive</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ sudo file /lib/x86_64-linux-gnu/libc.so.6 </span><br><span class="line">[sudo] password for chuck: </span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6: symbolic link to libc-2.27.so</span><br><span class="line">chuck@chuck11:~/bsp$ </span><br><span class="line">chuck@chuck11:~/bsp$ su</span><br><span class="line">Password: </span><br><span class="line">root@chuck11:/home/chuck/bsp# whereis libc-2.27.so</span><br><span class="line">libc-2.27: /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">root@chuck11:/home/chuck/bsp# </span><br><span class="line">root@chuck11:/home/chuck/bsp# file /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">/lib/x86_64-linux-gnu/libc-2.27.so: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/l, BuildID[sha1]=b417c0ba7cc5cf06d1d1bed6652cedb9253c60d0, for GNU/Linux 3.2.0, stripped</span><br></pre></td></tr></table></figure>
<p>除了自己的是没有去符号的，没有什么区别。</p>
<blockquote>
<p>总之，实践表明：自己的库，要想 <code>-static</code> 编进app，只能通过ar打包为静态库。</p>
</blockquote>
<blockquote>
<p>至于 <code>strip</code> 工具，我们另开篇讲。本身不在gcc的范畴。<br><br></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/12/linux%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" rel="prev" title="linux启动流程">
      <i class="fa fa-chevron-left"></i> linux启动流程
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/18/%E7%9F%A5%E8%A1%8C%E5%90%88%E4%B8%80/" rel="next" title="知行合一">
      知行合一 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#头文件的位置"><span class="nav-number">1.</span> <span class="nav-text">头文件的位置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#库的位置"><span class="nav-number">2.</span> <span class="nav-text">库的位置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GCC的编译过程"><span class="nav-number">3.</span> <span class="nav-text">GCC的编译过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#预处理"><span class="nav-number">3.1.</span> <span class="nav-text">预处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译"><span class="nav-number">3.2.</span> <span class="nav-text">编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#汇编"><span class="nav-number">3.3.</span> <span class="nav-text">汇编</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#链接"><span class="nav-number">3.4.</span> <span class="nav-text">链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcc-v"><span class="nav-number">3.5.</span> <span class="nav-text">gcc -v</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcc-Wall"><span class="nav-number">3.6.</span> <span class="nav-text">gcc -Wall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcc-g"><span class="nav-number">3.7.</span> <span class="nav-text">gcc -g</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcc-O"><span class="nav-number">3.8.</span> <span class="nav-text">gcc -O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#链接选项"><span class="nav-number">3.9.</span> <span class="nav-text">链接选项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#动态库和静态库"><span class="nav-number">3.9.1.</span> <span class="nav-text">动态库和静态库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#static"><span class="nav-number">3.9.2.</span> <span class="nav-text">-static</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">缑城散人</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gouchengsanren" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gouchengsanren" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">缑城散人</span>
</div>
  <div class="powered-by">
  </div>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_page_pv">本文阅读量<span id="busuanzi_value_page_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">本站总访客数<span id="busuanzi_value_site_uv"></span>人</span>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
